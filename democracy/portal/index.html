<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Newfoundland Civic Chat + Forum ‚Äî Offline-First Townless Council</title>
  <meta name="description" content="Standalone, offline-first civic chat + forum with proposals and voting. Anonymous, no signups. Gamified stewardship for Newfoundland communities." />
  <meta name="theme-color" content="#0d1421" />
  <style>
    :root{
      --bg:#0b1220; --panel:#10192c; --card:#0f1a2d; --ink:#e8f2ff; --muted:#9bb0cc;
      --accent:#4aa3ff; --accent2:#52d17a; --warn:#ffb844; --danger:#ff6b6b; --ok:#4ecdc4;
      --grid: rgba(255,255,255,.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 70% -10%,rgba(74,163,255,.15),transparent),
      radial-gradient(800px 600px at 10% 110%,rgba(82,209,122,.10),transparent),
      linear-gradient(180deg,var(--bg),#060a14);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    .grid{position:fixed;inset:0;pointer-events:none;background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);background-size: 24px 24px}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(6,10,20,.9),rgba(6,10,20,.6));backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:grid;gap:16px}
    .layout{grid-template-columns: 320px 1fr 350px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .card h3{margin:0 0 8px 0;font-size:14px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .card .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .card .body{padding:12px 14px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted)}
    input, textarea, select{width:100%;background:#0b1324;color:var(--ink);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px 12px;outline:0}
    textarea{min-height:90px;resize:vertical}
    button{background:linear-gradient(180deg,var(--accent),#3b8be0);border:0;color:white;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    button.secondary{background:#0b1324;color:var(--ink);border:1px solid rgba(255,255,255,.18)}
    .muted{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:12px}
    .msg,.post{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    .msg .meta,.post .meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;margin-bottom:6px}
    .flex{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:12px}
    .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18)}
    .tag{font-size:11px;padding:2px 6px;border-radius:6px;background:rgba(82,209,122,.16);border:1px solid rgba(82,209,122,.3);color:#bff4d6}
    .danger{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.3);color:#ffc6c6}
    .warn{background:rgba(255,184,68,.12);border-color:rgba(255,184,68,.3);color:#ffe2b8}
    .accent{background:rgba(74,163,255,.12);border-color:rgba(74,163,255,.35);color:#cfe6ff}
    .foot{font-size:12px;color:var(--muted);padding:10px 14px;border-top:1px solid rgba(255,255,255,.06)}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi{background:rgba(255,255,255,.04);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08)}
    .kpi b{display:block;font-size:20px}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap}
    .tabbar button{background:#0b1324;border:1px solid rgba(255,255,255,.18)}
    .hidden{display:none}
    .toast{position:fixed;right:12px;bottom:12px;padding:10px 12px;border-radius:12px;background:#0b1324;border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.3);}
    .banner{position:fixed;left:50%;transform:translateX(-50%);bottom:0;margin:0 auto;width:min(900px,92%);background:linear-gradient(180deg,rgba(10,16,28,.92),rgba(10,16,28,.88));border:1px solid rgba(255,255,255,.12);border-bottom:0;border-radius:16px 16px 0 0;backdrop-filter: blur(8px);padding:12px 14px;display:none}
    .banner.show{display:block}
    .hash{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;word-break:break-all;font-size:11px;color:var(--muted)}
    @media (max-width: 1100px){.layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="grid" aria-hidden="true"></div>
  <header>
    <div class="wrap flex" style="justify-content:space-between">
      <div class="flex" style="gap:10px">
        <div class="pill">üè¥‚Äç‚ò†Ô∏è Newfoundland Stewardship</div>
        <div class="pill" id="roomPill">Room: <b id="roomName">-</b></div>
        <div class="pill" id="onlinePill">Status: <span id="onlineStatus">offline-first</span></div>
      </div>
      <div class="flex" style="gap:8px">
        <button class="secondary" id="shareRoom">Share Room</button>
        <button class="secondary" id="exportData">Export</button>
        <button class="secondary" id="importData">Import</button>
        <button id="reset">Factory Reset</button>
      </div>
    </div>
  </header>

  <main class="wrap row layout" style="margin-top:16px">
    <!-- LEFT: Identity + KPIs + Tools -->
    <section class="col">
      <div class="card">
        <div class="head">
          <h3>Identity</h3>
          <span class="badge" id="stewardLevel">Seedling</span>
        </div>
        <div class="body col">
          <label>Display Name
            <input id="nickname" placeholder="Anonymous Puffin" />
          </label>
          <div class="flex" style="justify-content:space-between">
            <div class="kpi"><b id="credits">0</b><span class="muted">Steward Credits</span></div>
            <div class="kpi"><b id="badges">0</b><span class="muted">Badges</span></div>
          </div>
          <div class="flex" style="gap:6px;flex-wrap:wrap">
            <span class="tag">ü™™ No signups</span>
            <span class="tag">üß© Offline-first</span>
            <span class="tag">üéñÔ∏è Gamified</span>
            <span class="tag">üó≥Ô∏è Civic Tools</span>
          </div>
          <small class="muted">Your name + progress live only in your browser until you export/share. Anonymous by default.</small>
        </div>
        <div class="foot">
          <div class="hash" id="selfHash"></div>
        </div>
      </div>

      <div class="card">
        <div class="head"><h3>Room</h3></div>
        <div class="body col">
          <label>Join/Create Room
            <input id="roomInput" placeholder="e.g. twillingate-harbour" />
          </label>
          <div class="flex">
            <button id="setRoom">Set Room</button>
            <button class="secondary" id="newRoom">Random</button>
          </div>
          <small class="muted">Tip: use your community name (e.g., "bay-vert-cove") to anchor local discussions. Rooms are URL-hash based (no server).</small>
        </div>
      </div>

      <div class="card">
        <div class="head"><h3>Local Civic Tools</h3></div>
        <div class="body col">
          <div class="tabbar">
            <button class="secondary" data-tool="motion">üìù Motion</button>
            <button class="secondary" data-tool="vote">üó≥Ô∏è Vote</button>
            <button class="secondary" data-tool="budget">üí∞ Mini-Budget</button>
            <button class="secondary" data-tool="minutes">üßæ Minutes</button>
          </div>
          <div id="toolPanels" class="col">
            <div id="tool-motion" class="col">
              <input id="motionTitle" placeholder="Motion title (e.g., Form a Volunteer Harbour Committee)" />
              <textarea id="motionBody" placeholder="Describe the motion, responsibilities, and timeline."></textarea>
              <button id="addMotion">Add Motion</button>
            </div>
            <div id="tool-vote" class="col hidden">
              <input id="voteQuestion" placeholder="Question (e.g., Approve motion M-1?)" />
              <div class="flex"><input id="voteOptions" placeholder="Options comma-separated (Yes,No)" /><button class="secondary" id="createVote">Create</button></div>
              <div id="voteList" class="col"></div>
              <small class="muted">Quadratic voting: each browser has 9 voice credits per question. Casting k votes costs k¬≤.</small>
            </div>
            <div id="tool-budget" class="col hidden">
              <div class="flex"><input id="budgetTotal" type="number" placeholder="Total tokens (e.g., 1000)" /><button class="secondary" id="createBudget">Start</button></div>
              <div id="budgetBoard" class="col"></div>
              <small class="muted">Participatory mini-budget: propose line items, allocate your share, compare consensus.</small>
            </div>
            <div id="tool-minutes" class="col hidden">
              <textarea id="minutesText" placeholder="Meeting notes. Use timestamps and initials (e.g., [19:42] RF: ...)"></textarea>
              <button id="saveMinutes">Save Minutes</button>
              <div id="minutesHistory" class="col"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="head"><h3>Badges</h3></div>
        <div id="badgeList" class="body flex" style="gap:6px;flex-wrap:wrap"></div>
      </div>
    </section>

    <!-- CENTER: Forum + Chat -->
    <section class="col">
      <div class="card" id="forumCard">
        <div class="head"><h3>Community Forum</h3><span class="pill">Threaded ‚Ä¢ local-first</span></div>
        <div class="body col">
          <div class="flex">
            <input id="forumTitle" placeholder="Post title (e.g., Need ditch repair volunteers this Saturday)" />
          </div>
          <textarea id="forumBody" placeholder="Write your post. Markdown supported: **bold**, *italic*, lists, links."></textarea>
          <div class="flex">
            <input id="forumTags" placeholder="#roads #fundraiser #harbour" />
            <button id="addPost">Post</button>
          </div>
          <div class="list" id="forumList"></div>
        </div>
      </div>

      <div class="card" id="chatCard">
        <div class="head"><h3>Live Chat</h3><span class="pill" id="peerIndicator">p2p: local</span></div>
        <div class="body col" style="height:380px">
          <div id="chatList" class="list" style="height:300px;overflow:auto"></div>
          <div class="flex">
            <input id="chatInput" placeholder="Type a message‚Ä¶ (Shift+Enter = newline)" />
            <button id="sendChat">Send</button>
          </div>
        </div>
        <div class="foot">Tip: open this page on multiple devices with the same room hash to collaborate. Works offline on each device; sync via QR + export/import.</div>
      </div>
    </section>

    <!-- RIGHT: Newfoundland Helpers -->
    <section class="col">
      <div class="card">
        <div class="head"><h3>Townless Council Kit</h3></div>
        <div class="body col">
          <div class="kpis">
            <div class="kpi"><b id="kpiMotions">0</b><span class="muted">Open Motions</span></div>
            <div class="kpi"><b id="kpiVoters">0</b><span class="muted">Active Voters</span></div>
            <div class="kpi"><b id="kpiVols">0</b><span class="muted">Volunteers</span></div>
            <div class="kpi"><b id="kpiTasks">0</b><span class="muted">Tasks Completed</span></div>
          </div>
          <div class="col">
            <label>üìå Ward / Working Group
              <input id="wardName" placeholder="e.g., Harbour Restoration Ward" />
            </label>
            <label>‚úÖ Task / Call-out
              <input id="taskTitle" placeholder="e.g., Fill potholes on Seaview Rd" />
            </label>
            <div class="flex"><button id="addTask">Add Task</button><button class="secondary" id="completeTask">Mark Completed</button></div>
            <div id="taskList" class="col"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="head"><h3>Safety & Integrity</h3></div>
        <div class="body col">
          <div class="flex" style="justify-content:space-between">
            <span class="pill">Tamper-Evident</span>
            <button class="secondary" id="recalcHash">Re-hash</button>
          </div>
          <div class="hash" id="appHash">hash: ‚Ä¶</div>
          <small class="muted">This shows a client-side SHA-256 of core UI code + your data manifest. Changes trigger presentation banner.
          </small>
        </div>
        <div class="foot">Presentation mode triggers steward banner linking to planetaryrestorationarchive.com & github.com/TheRickyFoster</div>
      </div>

      <div class="card">
        <div class="head"><h3>Tips for Newfoundlanders</h3></div>
        <div class="body col">
          <div class="list">
            <div class="msg"><div class="meta">üçÅ Civic</div>Use <b>Room</b> = your community (e.g., <i>port-aux-basques</i>). Draft motions, vote locally, export the minutes and pin at the shop, church, or Facebook group.</div>
            <div class="msg"><div class="meta">ü§ù Volunteers</div>Use <b>Tasks</b> to coordinate rides, food drives, road repairs, harbour cleanups. Award Steward Credits when tasks complete.</div>
            <div class="msg"><div class="meta">üì° Offline</div>Install as PWA, sync by sharing QR + exporting/importing the JSON. No accounts, no servers.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="banner" id="stewardBanner">
    <div class="flex" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="flex" style="gap:10px;align-items:center">
        <span class="badge accent">Public Presentation Detected</span>
        <b>Verify source & stewardship:</b>
        <a class="pill" href="https://planetaryrestorationarchive.com" target="_blank" rel="noopener">planetaryrestorationarchive.com</a>
        <a class="pill" href="https://github.com/TheRickyFoster" target="_blank" rel="noopener">github.com/TheRickyFoster</a>
      </div>
      <div class="hash" id="bannerHash">‚Ä¶</div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const now = () => new Date().toISOString();
    const uid = (p="") => p + Math.random().toString(36).slice(2) + Date.now().toString(36);
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    // Simple SHA-256 for tamper-evident hashing
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function toast(msg){
      const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), 2500);
    }

    // ---------- Storage (room-scoped) ----------
    const DB = {
      key(k){ return `nfs:${state.room}:${k}`; },
      read(k,def){ try{ return JSON.parse(localStorage.getItem(this.key(k)) ?? JSON.stringify(def)); }catch(e){return def} },
      write(k,v){ localStorage.setItem(this.key(k), JSON.stringify(v)); hashAll(); },
    };

    const state = {
      room: (location.hash.replace('#','').trim()) || 'town-square',
      me: { id: uid('me_'), name: 'Anonymous Puffin', credits: 0, badges: [], level: 'Seedling' },
      data: { chat:[], posts:[], motions:[], votes:[], budgets:[], minutes:[], tasks:[], voters:{} },
      voice: 9 // quadratic voice per question (reset per question)
    };

    function load(){
      state.data.chat    = DB.read('chat',[]);
      state.data.posts   = DB.read('posts',[]);
      state.data.motions = DB.read('motions',[]);
      state.data.votes   = DB.read('votes',[]);
      state.data.budgets = DB.read('budgets',[]);
      state.data.minutes = DB.read('minutes',[]);
      state.data.tasks   = DB.read('tasks',[]);
      state.me           = DB.read('me', state.me);
    }

    function saveAll(){
      Object.entries(state.data).forEach(([k,v])=>DB.write(k,v));
      DB.write('me', state.me);
      renderAll();
    }

    // ---------- Render ----------
    function renderIdentity(){
      $('#nickname').value = state.me.name;
      $('#credits').textContent = state.me.credits;
      $('#badges').textContent = state.me.badges.length;
      $('#stewardLevel').textContent = state.me.level;
      $('#roomName').textContent = state.room;
      $('#onlineStatus').textContent = navigator.onLine ? 'online-ready' : 'offline-first';
      $('#badgeList').innerHTML = state.me.badges.map(b=>`<span class="badge">${b}</span>`).join('');
      $('#selfHash').textContent = `ID: ${state.me.id}`;
    }

    function renderChat(){
      const el = $('#chatList'); el.innerHTML = '';
      state.data.chat.slice(-200).forEach(m=>{
        const div = document.createElement('div'); div.className = 'msg';
        div.innerHTML = `<div class="meta">${m.name} ‚Ä¢ <span>${new Date(m.ts).toLocaleString()}</span></div>${escapeHTML(m.text)}`;
        el.appendChild(div);
      });
      el.scrollTop = el.scrollHeight;
    }

    function md(s){ // minimal markdown
      return s
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
        .replace(/\*(.*?)\*/g,'<i>$1</i>')
        .replace(/`([^`]+)`/g,'<code>$1</code>')
        .replace(/\n- (.*?)(?=\n|$)/g,'<li>$1</li>')
        .replace(/\n/g,'<br>');
    }
    function escapeHTML(s){ return md(String(s ?? '')); }

    function renderForum(){
      const list = $('#forumList'); list.innerHTML = '';
      state.data.posts.slice().reverse().forEach(p=>{
        const div = document.createElement('div'); div.className='post';
        const tags = (p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join(' ');
        const comments = (p.comments||[]).map(c=>`<div class="msg"><div class=meta>${c.name} ‚Ä¢ ${new Date(c.ts).toLocaleString()}</div>${escapeHTML(c.text)}</div>`).join('');
        div.innerHTML = `<div class=meta><b>${escapeHTML(p.title)}</b> ‚Ä¢ ${p.name} ‚Ä¢ ${new Date(p.ts).toLocaleString()} ${tags}</div>
          <div>${escapeHTML(p.body)}</div>
          <div class="col" style="margin-top:8px">
            <div class="flex"><input data-cid="${p.id}" placeholder="Reply‚Ä¶"/><button class="secondary" data-reply="${p.id}">Reply</button></div>
            <div class="col">${comments}</div>
          </div>`;
        list.appendChild(div);
      });
      // wire reply buttons
      list.querySelectorAll('button[data-reply]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.getAttribute('data-reply');
          const input = list.querySelector(`input[data-cid="${id}"]`);
          const text = input.value.trim(); if(!text) return;
          const post = state.data.posts.find(x=>x.id===id); if(!post) return;
          post.comments = post.comments||[];
          post.comments.push({ id: uid('c_'), name: state.me.name, text, ts: now()});
          award('Helper'); state.me.credits += 1; saveAll(); input.value='';
        };
      });
    }

    function renderMotions(){
      $('#kpiMotions').textContent = state.data.motions.length;
    }

    function renderVotes(){
      const container = $('#voteList'); container.innerHTML = '';
      state.data.votes.forEach(q=>{
        const div = document.createElement('div'); div.className='msg';
        const options = q.options.map((o,i)=>{
          const my = q.ballots[state.me.id]?.[i] || 0;
          return `<div class="flex" style="justify-content:space-between"><span>${o}</span>
            <div class="flex" style="gap:4px;align-items:center">
              <button class="secondary" data-down="${q.id}:${i}">-</button>
              <span>${my}</span>
              <button class="secondary" data-up="${q.id}:${i}">+</button>
            </div></div>`;
        }).join('');
        const totals = q.options.map((o,i)=> Object.values(q.ballots).reduce((a,b)=>a+(b[i]||0),0));
        const totalHTML = `<div class="muted">Totals: ${totals.map((t,i)=>`${q.options[i]}=${t}`).join(' ‚Ä¢ ')}</div>`;
        div.innerHTML = `<div class=meta><b>${escapeHTML(q.question)}</b> ‚Ä¢ ${new Date(q.ts).toLocaleString()} ‚Ä¢ voice=${q.voice[state.me.id]??9}</div>${options}${totalHTML}`;
        container.appendChild(div);
      });
      // wire up/down
      container.querySelectorAll('button[data-up]').forEach(b=> b.onclick = ()=>voteAdjust(b.getAttribute('data-up'), +1));
      container.querySelectorAll('button[data-down]').forEach(b=> b.onclick = ()=>voteAdjust(b.getAttribute('data-down'), -1));
    }

    function renderBudget(){ /* simple list */ }
    function renderMinutes(){
      const wrap = $('#minutesHistory'); wrap.innerHTML = '';
      state.data.minutes.slice().reverse().forEach(m=>{
        const div = document.createElement('div'); div.className='msg';
        div.innerHTML = `<div class=meta>${new Date(m.ts).toLocaleString()} ‚Ä¢ ${m.name}</div>${escapeHTML(m.text)}`;
        wrap.appendChild(div);
      });
    }

    function renderTasks(){
      const list = $('#taskList'); list.innerHTML = '';
      state.data.tasks.forEach(t=>{
        const div = document.createElement('div'); div.className='msg';
        div.innerHTML = `<div class=meta>${t.ward||'Ward'} ‚Ä¢ ${new Date(t.ts).toLocaleString()} ${t.done?'<span class="tag">done</span>':''}</div>${escapeHTML(t.title)}`;
        list.appendChild(div);
      });
      $('#kpiTasks').textContent = state.data.tasks.filter(t=>t.done).length;
    }

    function renderAll(){
      renderIdentity(); renderChat(); renderForum(); renderMotions(); renderVotes(); renderMinutes(); renderTasks();
    }

    // ---------- Actions ----------
    function addChat(text){
      state.data.chat.push({ id: uid('m_'), name: state.me.name, text, ts: now() });
      state.me.credits += 1; saveAll();
    }

    function addPost(title, body, tags){
      state.data.posts.push({ id: uid('p_'), name: state.me.name, title, body, tags, comments: [], ts: now() });
      state.me.credits += 2; award('Organizer'); saveAll();
    }

    function addMotion(title, body){
      state.data.motions.push({ id: uid('mo_'), title, body, name: state.me.name, ts: now(), status:'open' });
      state.me.credits += 3; award('Civic Founder'); saveAll();
    }

    function createVote(question, options){
      const id = uid('q_');
      const ballots = {}; const voice = {}; voice[state.me.id] = 9;
      state.data.votes.push({ id, question, options, ballots, voice, ts: now() }); saveAll();
    }

    function voteAdjust(key, dir){
      const [qid, idx] = key.split(':');
      const q = state.data.votes.find(x=>x.id===qid); if(!q) return;
      q.ballots[state.me.id] = q.ballots[state.me.id] || new Array(q.options.length).fill(0);
      q.voice[state.me.id] = q.voice[state.me.id] ?? 9;
      const curr = q.ballots[state.me.id][idx];
      const proposed = clamp(curr + dir, 0, 9);
      const costCurr = curr*curr, costProp = proposed*proposed;
      if(costProp <= 81){ // cap by 9^2 voice bank
        q.ballots[state.me.id][idx] = proposed;
        q.voice[state.me.id] = 9 - Math.max(...q.ballots[state.me.id]); // simple cost proxy
        saveAll();
      } else { toast('Out of voice credits for this question'); }
    }

    function createBudget(total){
      const id = uid('b_'); state.data.budgets.push({id,total: Number(total)||0, lines:[], ts: now()}); saveAll();
    }

    function saveMinutes(txt){ state.data.minutes.push({ id: uid('mn_'), text: txt, name: state.me.name, ts: now()}); state.me.credits+=1; saveAll(); }

    function addTask(title, ward){ state.data.tasks.push({ id: uid('t_'), title, ward, done:false, ts: now()}); state.me.credits+=1; saveAll(); }
    function completeTask(){ const t = state.data.tasks.find(x=>!x.done); if(t){t.done=true; award('Neighbourly'); state.me.credits+=2; saveAll();} }

    function award(name){ if(!state.me.badges.includes(name)){ state.me.badges.push(name); levelUp(); } }
    function levelUp(){ const pts = state.me.credits; state.me.level = pts>80?'Harbour Master': pts>40?'Navigator': pts>20?'Boatswain': pts>10?'Deckhand':'Seedling'; }

    // ---------- UI Events ----------
    $('#nickname').oninput = e=>{ state.me.name = e.target.value.trim()||'Anonymous Puffin'; DB.write('me', state.me); renderIdentity(); };
    $('#sendChat').onclick = ()=>{ const t=$('#chatInput'); const v=t.value.trim(); if(!v) return; addChat(v); t.value=''; };
    $('#chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('#sendChat').click(); }});

    $('#addPost').onclick = ()=>{
      const title=$('#forumTitle').value.trim(); const body=$('#forumBody').value.trim(); if(!title||!body) return;
      const tags=$('#forumTags').value.split(/\s+/).filter(Boolean);
      addPost(title, body, tags); $('#forumTitle').value=''; $('#forumBody').value=''; $('#forumTags').value='';
    };

    $('#addMotion').onclick = ()=>{ const t=$('#motionTitle').value.trim(), b=$('#motionBody').value.trim(); if(!t||!b) return; addMotion(t,b); $('#motionTitle').value=''; $('#motionBody').value=''; };
    $('#createVote').onclick = ()=>{ const q=$('#voteQuestion').value.trim(); const opts=$('#voteOptions').value.split(',').map(s=>s.trim()).filter(Boolean); if(!q||opts.length<2) return; createVote(q,opts); $('#voteQuestion').value=''; $('#voteOptions').value=''; };
    $('#createBudget').onclick = ()=>{ createBudget($('#budgetTotal').value); };
    $('#saveMinutes').onclick = ()=>{ const t=$('#minutesText').value.trim(); if(t) saveMinutes(t); $('#minutesText').value=''; };
    $('#addTask').onclick = ()=>{ const t=$('#taskTitle').value.trim(); if(!t) return; addTask(t, $('#wardName').value.trim()); $('#taskTitle').value=''; };
    $('#completeTask').onclick = completeTask;

    // Tool tabs
    $$('#toolPanels .col').forEach((p,i)=>{ if(i>0) p.classList.add('hidden'); });
    $$('.tabbar button').forEach(btn=>btn.onclick = ()=>{
      const id = btn.dataset.tool; $$('#toolPanels .col').forEach(el=>el.classList.add('hidden')); $('#tool-'+id).classList.remove('hidden');
    });

    // Room handling
    function setRoom(name){ state.room = (name||'town-square').toLowerCase().replace(/[^a-z0-9\-]/g,'-'); location.hash = state.room; load(); renderAll(); toast(`Room set to ${state.room}`); }
    $('#setRoom').onclick = ()=> setRoom($('#roomInput').value.trim());
    $('#newRoom').onclick = ()=> setRoom(uid('ward-').slice(5,15));

    // Share / Export / Import / Reset
    $('#shareRoom').onclick = async ()=>{
      const url = location.href.split('#')[0] + '#' + state.room;
      try{ await navigator.share({ title:'Join our Townless Council room', text:`Room: ${state.room}`, url}); }
      catch{ navigator.clipboard.writeText(url); toast('Room URL copied'); }
    };
    $('#exportData').onclick = ()=>{
      const blob = new Blob([JSON.stringify({room:state.room, me:state.me, data:state.data}, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `civic-room-${state.room}.json`; a.click();
    };
    $('#importData').onclick = ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = async ()=>{
        const file = inp.files[0]; if(!file) return; const txt = await file.text();
        try{ const obj = JSON.parse(txt); if(obj.data){ state.data = obj.data; if(obj.me) state.me = obj.me; renderAll(); saveAll(); } }
        catch{ toast('Invalid file'); }
      }; inp.click();
    };
    $('#reset').onclick = ()=>{ if(confirm('Erase local data for this room?')){ Object.keys(localStorage).filter(k=>k.startsWith(`nfs:${state.room}:`)).forEach(k=>localStorage.removeItem(k)); load(); renderAll(); hashAll(); }};

    // ---------- Hashing & Banner ----------
    async function hashAll(){
      const core = document.querySelector('head').innerHTML + document.querySelector('body').innerHTML.replace(/<div class=\"banner[\s\S]*?<\/div>/,'');
      const data = JSON.stringify(state);
      const h = await sha256(core + '|' + data);
      $('#appHash').textContent = 'hash: ' + h;
      $('#bannerHash').textContent = h.slice(0,16) + '‚Ä¶';
    }

    function detectPresentation(){
      const w = window.innerWidth, h = window.innerHeight;
      const big = w*h > 1_200_000; // ~> projector / big screen
      const fs = document.fullscreenElement != null;
      const show = big || fs; $('#stewardBanner').classList.toggle('show', show);
    }

    window.addEventListener('resize', detectPresentation);
    document.addEventListener('fullscreenchange', detectPresentation);
    $('#recalcHash').onclick = hashAll;

    // ---------- Service Worker (offline cache) ----------
    if('serviceWorker' in navigator){
      const sw = `self.addEventListener('install', e=>{ e.waitUntil(caches.open('civic-v1').then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).catch(()=>caches.match('./')))); });`;
      const blob = new Blob([sw], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url);
    }

    // ---------- Init ----------
    function init(){
      load(); renderAll(); hashAll(); detectPresentation();
      window.addEventListener('storage', e=>{ if(e.key?.startsWith(`nfs:${state.room}:`)){ load(); renderAll(); hashAll(); }});
      $('#roomInput').value = state.room; $('#roomName').textContent = state.room;
    }
    init();
  </script>
</body>
</html>
